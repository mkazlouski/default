#!/bin/bash
BECOME='sudo -E'
set -xueo pipefail
test "$(arch)" == "x86_64"

$BECOME rpm --import "http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x8320CA65CB2DE8E5"
$BECOME bash -c 'cat > /etc/yum.repos.d/onlyoffice.repo' << EOF
[onlyoffice]
name=onlyoffice repo
baseurl=http://download.onlyoffice.com/repo/centos/main/noarch/
gpgcheck=1
enabled=1
EOF

$BECOME bash -c 'cat > /etc/yum.repos.d/google-chrome.repo' << EOF
[google-chrome]
name=google-chrome
baseurl=http://dl.google.com/linux/chrome/rpm/stable/x86_64
enabled=1
gpgcheck=1
gpgkey=https://dl.google.com/linux/linux_signing_key.pub
EOF

$BECOME dnf install -y \
    @base-x \
    GConf2 \
    bash-completion \
    bzip2 \
    dejavu-sans-fonts \
    dejavu-sans-mono-fonts \
    eog \
    evince \
    file-roller \
    gedit \
    gnome-disk-utility \
    gnome-shell \
    gnome-terminal \
    gnupg \
    google-chrome-stable \
    gvfs-mtp \
    iwl7260-firmware \
    mesa-dri-drivers \
    nautilus \
    onlyoffice-desktopeditors \
    tar \
    unar \
    xdg-user-dirs \
    xdg-utils \
    xorg-x11-drv-intel

$BECOME ln -s /usr/lib64/libcurl.so.4 /usr/lib64/libcurl-gnutls.so.4 || true

$BECOME systemctl set-default graphical.target
$BECOME systemctl enable gdm.service

xdg-user-dirs-update --force
$BECOME chown -R "$(id -g)":"$(id -u)" "$HOME/" || true

dconf load / << EOF
[org/gnome/settings-daemon/plugins/power]
power-button-action='suspend'
sleep-inactive-battery-type='nothing'
sleep-inactive-ac-timeout=3600
sleep-inactive-ac-type='nothing'
sleep-inactive-battery-timeout=1800

[org/gnome/settings-daemon/plugins/color]
night-light-schedule-automatic=true
night-light-enabled=true

[org/gnome/settings-daemon/plugins/xsettings]
antialiasing='rgba'
hinting='full'

[org/gnome/settings-daemon/peripherals/touchscreen]
orientation-lock=true

[org/gnome/desktop/interface]
clock-show-date=true
clock-format='12h'
enable-animations=false

[org/gnome/desktop/media-handling]
autorun-never=true

[org/gnome/desktop/session]
idle-delay=uint32 0

[org/gnome/desktop/input-sources]
sources=[('xkb', 'us'), ('xkb', 'ru')]
mru-sources=[('xkb', 'us'), ('xkb', 'ru')]
xkb-options=@as []
EOF
